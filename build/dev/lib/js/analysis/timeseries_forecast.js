"use strict";define(["../chart/line_chart","../chart/datatables","../util/utils","ng!$q","../../vendor/d3-format.min"],function(e,r,a,o,t){return{createCube:function(e,r){var o=r.layout,t=a.validateDimension(o.props.dimensions[0]),s=[{qNullSuppression:!0,qDef:{qFieldDefs:[t],qSortCriterias:[{qSortByNumeric:1}]}}],i=a.validateMeasure(o.props.measures[0]),l="";l=o.props.autoARIMA?"fit<-auto.arima(data);":"fit<-arima(data, order=c("+o.props.AROrder+","+o.props.DegreeOfDifferencing+","+o.props.MAOrder+")\n                      ,seasonal=list(order=c("+o.props.SeasonalAROrder+","+o.props.SeasonalDegreeOfDifferencing+","+o.props.SeasonalMAOrder+"), period="+o.props.frequency+"));";var p="";o.props.frequency>0&&(p=",frequency="+o.props.frequency),a.displayDebugModeMessage(o.props.debugMode);var n=a.getDebugSaveDatasetScript(o.props.debugMode,"debug_timeseries_forecast.rda"),d="R.ScriptEvalExStr('N', '"+n+" library(jsonlite);library(dplyr);library(forecast);data<-ts(na.omit(q$Measure) "+p+");"+l+"\n      res<-forecast(fit, level="+o.props.confidenceLevel+", h="+o.props.forecastingPeriods+");\n      json<-toJSON(list(as.double(res$mean),as.double(res$upper),as.double(res$lower),arimaorder(fit))); json;', "+i+" as Measure)";a.displayRScriptsToConsole(o.props.debugMode,[d]);var u=[{qDef:{qDef:i}},{qDef:{qDef:d}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}}];return r.backendApi.applyPatches([{qPath:"/qHyperCubeDef/qDimensions",qOp:"replace",qValue:JSON.stringify(s)},{qPath:"/qHyperCubeDef/qMeasures",qOp:"replace",qValue:JSON.stringify(u)}],!1),r.patchApplied=!0,null},drawChart:function(t,s){var i=o.defer(),l=t.layout,p=[{qTop:0,qLeft:0,qWidth:6,qHeight:1500}];return t.backendApi.getData(p).then(function(o){var p=null,n=o[0].qMatrix;if(0===n[0][2].qText.length||"-"==n[0][2].qText)for(var d=0;d<n.length;d++)0!==n[d][2].qText.length&&"-"!==n[d][2].qText&&(p=JSON.parse(n[d][2].qText));else p=JSON.parse(n[0][2].qText);if(null==p)a.displayConnectionError(t.extId);else{a.displayReturnedDatasetToConsole(l.props.debugMode,o[0]);var u=a.getDefaultPaletteColor(),c=p[0],m=p[1],h=p[2],f=p[3],g=l.props.limit;if("undefined"==typeof t.layout.props.displayTable||0==t.layout.props.displayTable){var b={},q=o[0].qMatrix.length,y=[],v=[],x=[];$.each(o[0].qMatrix,function(e,r){y.push(r[0].qElemNumber),v.push(r[0].qText),x.push(r[1].qNum)}),b.elemNum=y,b.dim1=v,b.mea1=x;for(var D=new Array(q),M=new Array(q),S=new Array(q),A=new Array(q),w=0;w<l.props.forecastingPeriods;w++)b.dim1.push("+"+(w+1)),D.push(c[w]),M.push(m[w]),S.push(h[w]),A.push(g);b.mea2=D,b.mea3=M,b.mea4=S,b.mea5=A;var N="";0<f.length&&f.length<=3?N="("+f[0]+","+f[1]+","+f[2]+")":f.length<=6?N="("+f[0]+","+f[1]+","+f[2]+")("+f[3]+","+f[4]+","+f[5]+")":6<f.length&&(N="("+f[0]+","+f[1]+","+f[2]+")("+f[3]+","+f[4]+","+f[5]+")["+f[6]+"]");var R=[{x:b.dim1,y:b.mea1,elemNum:b.elemNum,name:"Observed",mode:"lines+markers",fill:l.props.line,fillcolor:l.props.colors?"rgba("+u[3]+",0.3)":"rgba("+a.getConversionRgba(l.props.colorForMain.color,1)+")",marker:{color:l.props.colors?"rgba("+u[3]+",1)":"rgba("+a.getConversionRgba(l.props.colorForMain.color,1)+")",size:l.props.datapoints?l.props.pointRadius:1},line:{width:l.props.borderWidth}},{x:b.dim1,y:b.mea2,name:"Fit",mode:"lines+markers",marker:{color:l.props.colors?"rgba("+u[7]+",1)":"rgba("+a.getConversionRgba(l.props.colorForSub.color,1)+")",size:l.props.datapoints?l.props.pointRadius:1},line:{width:l.props.borderWidth}},{x:b.dim1,y:b.mea3,name:"Upper",fill:"tonexty",fillcolor:l.props.colors?"rgba("+u[7]+",0.3)":"rgba("+a.getConversionRgba(l.props.colorForSub.color,.3)+")",type:"scatter",mode:"none"},{x:b.dim1,y:b.mea4,name:"Lower",fill:"tonexty",fillcolor:l.props.colors?"rgba("+u[7]+",0.3)":"rgba("+a.getConversionRgba(l.props.colorForSub.color,.3)+")",type:"scatter",mode:"none"},{x:b.dim1,y:b.mea5,name:l.props.limitlabel,mode:"lines",marker:{color:"rgba("+a.getConversionRgba(l.props.limitcolor.color,1)+")",size:l.props.datapoints?l.props.pointRadius:1},line:{dash:l.props.limitstyle,width:l.props.limitwidth}}],C={xaxis:{type:"category",title:t.layout.props.xLabelsAndTitle?t.layout.props.dimensions[0].label:"",showgrid:t.layout.props.xScale,side:t.layout.props.xAxisPosition}};l.props.displayARIMAParams?$(".advanced-analytics-toolsets-"+t.extId).html('\n                <div style="width:100%;height:5%;text-align:right;">ARIMA'+N+'</div>\n                <div id="aat-chart-'+t.extId+'" style="width:100%;height:95%;"></div>\n              '):$(".advanced-analytics-toolsets-"+t.extId).html('<div id="aat-chart-'+t.extId+'" style="width:100%;height:100%;"></div>');var O=e.draw(t,R,"aat-chart-"+t.extId,C);e.setEvents(O,t,s)}else{var T=a.getLocale(t,0),I=a.getNumberFormat(t,0),F=(o[0].qMatrix.length,[]);$.each(o[0].qMatrix,function(e,r){F.push([r[0].qElemNumber,r[0].qText,T.format(I)(r[1].qNum).replace(/G/,"B"),"","",""])});for(var L=0;L<l.props.forecastingPeriods;L++)F.push(["","+"+(L+1),"",T.format(I)(c[L]).replace(/G/,"B"),T.format(I)(m[L]).replace(/G/,"B"),T.format(I)(h[L]).replace(/G/,"B")]);var P='\n              <table id="aat-table-'+t.extId+'" class="display">\n                <thead>\n                  <tr>\n                    <th>qElemNumber</th>\n                    <th>'+t.layout.props.dimensions[0].label+"</th>\n                    <th>"+t.layout.props.measures[0].label+"</th>\n                    <th>Fit</th>\n                    <th>Lower</th>\n                    <th>Upper</th>\n                  </tr>\n                </thead>\n                <tbody>\n                </tbody>\n              </table>";r.draw(s,t,"#aat-table-"+t.extId,F,P,null).then(function(e){r.setEvents(e,t,s)})}}return i.resolve()}),i.promise}}});
//# sourceMappingURL=../../maps/analysis/timeseries_forecast.js.map
